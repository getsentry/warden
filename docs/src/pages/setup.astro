---
import Base from '../layouts/Base.astro';
import Terminal from '../components/Terminal.astro';
import { Code } from 'astro:components';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<Base title="Setup" description="Set up Warden locally or in your GitHub repository">
  <h1>Setup</h1>

  <p>Set up Warden once. It watches every change from there.</p>

  <h2>Local CLI (Quick Start)</h2>

  <p>Get started in seconds. No configuration required.</p>

  <Terminal title="Terminal" showCopy={true}>
    <Code
      code={`# Set your API key
export WARDEN_ANTHROPIC_API_KEY=sk-ant-...

# Run security review on uncommitted changes
npx warden --skill security-review

# Run on specific files
npx warden src/auth.ts --skill security-review

# Run on git changes
npx warden HEAD~3

# Found something? Fix it immediately
npx warden --fix`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>

  <p>For more CLI options, see the <a href="https://github.com/dcramer/warden#cli-reference">CLI reference</a>.</p>

  <h2>GitHub Action Setup</h2>

  <h3>Prerequisites</h3>

  <ul>
    <li>A GitHub repository</li>
    <li>An Anthropic API key (<a href="https://console.anthropic.com/">get one here</a>)</li>
  </ul>

  <h3>1. Add Your API Key</h3>

  <p>Add your Anthropic API key as a repository secret:</p>

  <ol>
    <li>Go to your repository on GitHub</li>
    <li>Navigate to <strong>Settings → Secrets and variables → Actions</strong></li>
    <li>Click <strong>New repository secret</strong></li>
    <li>Name: <code>WARDEN_ANTHROPIC_API_KEY</code></li>
    <li>Value: Your API key from <a href="https://console.anthropic.com/">console.anthropic.com</a></li>
  </ol>

  <h3>2. Create the Workflow</h3>

  <p>Create <code>.github/workflows/warden.yml</code>:</p>

  <Terminal title=".github/workflows/warden.yml" showCopy={true}>
    <Code
      code={`name: Warden
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  warden:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: getsentry/warden-action@v1
        with:
          anthropic-api-key: \${{ secrets.WARDEN_ANTHROPIC_API_KEY }}
          github-token: \${{ secrets.GITHUB_TOKEN }}`}
      lang="yaml"
      theme="vitesse-black"
    />
  </Terminal>

  <h4>Action Inputs</h4>

  <table>
    <thead>
      <tr>
        <th>Input</th>
        <th>Required</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>anthropic-api-key</code></td>
        <td>Yes</td>
        <td>Your Anthropic API key</td>
      </tr>
      <tr>
        <td><code>github-token</code></td>
        <td>Yes</td>
        <td>GitHub token for posting comments (use <code>secrets.GITHUB_TOKEN</code>)</td>
      </tr>
      <tr>
        <td><code>config-path</code></td>
        <td>No</td>
        <td>Path to config file (default: <code>warden.toml</code>)</td>
      </tr>
      <tr>
        <td><code>fail-on</code></td>
        <td>No</td>
        <td>Minimum severity to fail the action: <code>critical</code>, <code>high</code>, <code>medium</code>, <code>low</code></td>
      </tr>
      <tr>
        <td><code>comment-on</code></td>
        <td>No</td>
        <td>Minimum severity to show in comments: <code>critical</code>, <code>high</code>, <code>medium</code>, <code>low</code>. Independent of <code>fail-on</code>.</td>
      </tr>
    </tbody>
  </table>

  <h2>Using a GitHub App (Optional)</h2>

  <p>
    By default, Warden uses <code>GITHUB_TOKEN</code> which works well for most setups.
    However, you can create a dedicated GitHub App for a better experience:
  </p>

  <ul>
    <li>Comments appear from a custom "Warden" bot instead of generic "github-actions"</li>
    <li>Fine-grained permissions (only what's needed)</li>
    <li>App can be shared across repos in an organization</li>
  </ul>

  <h3>1. Create the App</h3>

  <p>Run the setup command to create a GitHub App:</p>

  <Terminal title="Terminal" showCopy={true}>
    <Code
      code={`# For a personal account
npx warden setup-app

# For an organization
npx warden setup-app --org your-org`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>

  <p>This creates an app with the following permissions:</p>

  <ul>
    <li><strong>Contents:</strong> Read — to access repository files</li>
    <li><strong>Pull requests:</strong> Write — to post review comments</li>
    <li><strong>Issues:</strong> Write — to add labels and comments</li>
    <li><strong>Checks:</strong> Write — to report status</li>
    <li><strong>Metadata:</strong> Read — required for all apps</li>
  </ul>

  <h3>2. Install the App</h3>

  <p>
    After creating the app, the command outputs an installation URL. Click it to install the app
    on your repositories. You can choose to install on all repositories or select specific ones.
  </p>

  <h3>3. Add Secrets</h3>

  <p>Add these secrets to your repository (Settings → Secrets and variables → Actions):</p>

  <ul>
    <li><code>WARDEN_APP_ID</code> — The App ID shown after creation</li>
    <li><code>WARDEN_PRIVATE_KEY</code> — The private key (PEM file contents)</li>
  </ul>

  <h3>4. Update Your Workflow</h3>

  <p>Modify your workflow to generate a token from the GitHub App:</p>

  <Terminal title=".github/workflows/warden.yml" showCopy={true}>
    <Code
      code={`name: Warden
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  warden:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: \${{ secrets.WARDEN_APP_ID }}
          private-key: \${{ secrets.WARDEN_PRIVATE_KEY }}

      - uses: getsentry/warden-action@v1
        with:
          anthropic-api-key: \${{ secrets.WARDEN_ANTHROPIC_API_KEY }}
          github-token: \${{ steps.app-token.outputs.token }}`}
      lang="yaml"
      theme="vitesse-black"
    />
  </Terminal>

  <h3>3. Create the Configuration</h3>

  <p>Create <code>warden.toml</code> in your repository root:</p>

  <Terminal title="warden.toml" showCopy={true}>
    <Code
      code={`version = 1

[[triggers]]
name = "Security Review"
event = "pull_request"
actions = ["opened", "synchronize"]
skill = "security-review"`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h2>Configuration Reference</h2>

  <h3>Triggers</h3>

  <p>Each trigger maps GitHub events to skills that should run.</p>

  <Terminal title="warden.toml" showCopy={true}>
    <Code
      code={`[[triggers]]
name = "Security Review"           # Display name
event = "pull_request"             # GitHub event type
actions = ["opened", "synchronize"] # Which actions trigger this
skill = "security-review"          # Skill to run

# Optional: filter by file paths
[triggers.filters]
paths = ["src/**/*.ts"]            # Only run on matching files
ignorePaths = ["**/*.test.ts"]     # Exclude test files

# Optional: output configuration
[triggers.output]
failOn = "high"                    # Fail CI if high+ severity found
commentOn = "high"                 # Only show high+ severity in comments
maxFindings = 10                   # Limit to 10 findings in output
labels = ["security"]              # Always add this label when trigger runs`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h4>Supported Events</h4>

  <table>
    <thead>
      <tr>
        <th>Event</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>pull_request</code></td>
        <td><code>opened</code>, <code>synchronize</code>, <code>reopened</code>, <code>closed</code></td>
      </tr>
    </tbody>
  </table>

  <h3>Multiple Triggers</h3>

  <p>You can define multiple triggers for different scenarios:</p>

  <Terminal title="warden.toml" showCopy={true}>
    <Code
      code={`version = 1

# Run security review on all PRs
[[triggers]]
name = "Security Review"
event = "pull_request"
actions = ["opened", "synchronize"]
skill = "security-review"

# Run a custom skill only on specific paths
[[triggers]]
name = "API Review"
event = "pull_request"
actions = ["opened"]
skill = "api-review"

[triggers.filters]
paths = ["src/api/**/*.ts"]`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h2>Custom Skills</h2>

  <p>Define custom skills in <code>.warden/skills/</code>.</p>

  <h3>Verify Setup</h3>

  <p>Open a pull request to test your configuration. You should see:</p>

  <ol>
    <li>The Warden action running in the PR checks</li>
    <li>Review comments appearing on the PR if issues are found</li>
    <li>A summary comment with all findings</li>
  </ol>

  <h2>Local Development Workflow</h2>

  <p>Run Warden locally before pushing to catch issues early. This is faster and cheaper than waiting for CI.</p>

  <Terminal title="Terminal" showCopy={true}>
    <Code
      code={`# Before committing: check your changes
warden --skill security-review

# Before pushing: check everything since main
warden main..HEAD --skill security-review

# Found issues? Apply fixes automatically
warden --fix`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>

  <p>Use <code>--json</code> and <code>--fail-on</code> to integrate with your own CI scripts.</p>
</Base>

<style>
  h1 {
    margin-bottom: 0.5rem;
  }

  h2 {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  h4 {
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.9rem;
  }

  th, td {
    text-align: left;
    padding: 0.75rem;
    border: 1px solid var(--border);
  }

  th {
    background: rgba(255, 255, 255, 0.03);
    font-weight: 600;
  }

  td code {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.85em;
  }

  ol, ul {
    padding-left: 1.5rem;
  }

  li {
    margin-bottom: 0.5rem;
  }
</style>
