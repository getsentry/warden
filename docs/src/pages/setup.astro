---
import Base from '../layouts/Base.astro';
import Terminal from '../components/Terminal.astro';
import { Code } from 'astro:components';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<Base title="Setup" description="Set up Warden locally or in your GitHub repository">
  <h1>Setup</h1>

  <p>Configure Warden once for your entire organization.</p>

  <h2>Quick Start (Local CLI)</h2>

  <Terminal title="Terminal" showCopy={true}>
    <Code
      code={`# Set your API key
export WARDEN_ANTHROPIC_API_KEY=sk-ant-...

# Review uncommitted changes
npx warden --skill security-review

# Review specific files
npx warden src/auth.ts --skill security-review

# Review recent commits
npx warden HEAD~3

# Auto-fix findings
npx warden --fix`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>

  <p>See the <a href={`${base}/cli`}>CLI reference</a> for all options.</p>

  <h2>GitHub Action</h2>

  <h3>1. Set Organization Secrets</h3>

  <p>
    Set secrets at the organization level so all repositories share them.
    Go to your GitHub organization's <strong>Settings → Secrets and variables → Actions</strong>.
  </p>

  <h4>Required Secrets</h4>

  <table>
    <thead>
      <tr>
        <th>Secret</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>WARDEN_ANTHROPIC_API_KEY</code></td>
        <td>Your API key from <a href="https://console.anthropic.com/">console.anthropic.com</a></td>
      </tr>
    </tbody>
  </table>

  <h4>Optional Secrets</h4>

  <table>
    <thead>
      <tr>
        <th>Secret</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>WARDEN_MODEL</code></td>
        <td>Model to use (e.g., <code>claude-sonnet-4-20250514</code>)</td>
      </tr>
    </tbody>
  </table>

  <h3>2. Create the Workflow</h3>

  <p>Add <code>.github/workflows/warden.yml</code> to each repository:</p>

  <Terminal title=".github/workflows/warden.yml" showCopy={true}>
    <Code
      code={`name: Warden

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  WARDEN_ANTHROPIC_API_KEY: \${{ secrets.WARDEN_ANTHROPIC_API_KEY }}
  WARDEN_MODEL: \${{ secrets.WARDEN_MODEL }}

jobs:
  warden:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: getsentry/warden-action@v1
        with:
          github-token: \${{ secrets.GITHUB_TOKEN }}`}
      lang="yaml"
      theme="vitesse-black"
    />
  </Terminal>

  <h4>Action Inputs</h4>

  <table>
    <thead>
      <tr>
        <th>Input</th>
        <th>Required</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>github-token</code></td>
        <td>No</td>
        <td>GitHub token for posting comments (defaults to <code>GITHUB_TOKEN</code>)</td>
      </tr>
      <tr>
        <td><code>anthropic-api-key</code></td>
        <td>No</td>
        <td>Anthropic API key (falls back to <code>WARDEN_ANTHROPIC_API_KEY</code> env var)</td>
      </tr>
      <tr>
        <td><code>config-path</code></td>
        <td>No</td>
        <td>Path to config file (default: <code>warden.toml</code>)</td>
      </tr>
      <tr>
        <td><code>fail-on</code></td>
        <td>No</td>
        <td>Minimum severity to fail: <code>critical</code>, <code>high</code>, <code>medium</code>, <code>low</code></td>
      </tr>
      <tr>
        <td><code>comment-on</code></td>
        <td>No</td>
        <td>Minimum severity to comment: <code>critical</code>, <code>high</code>, <code>medium</code>, <code>low</code></td>
      </tr>
    </tbody>
  </table>

  <h3>3. Add Configuration</h3>

  <p>Create <code>warden.toml</code> in your repository root:</p>

  <Terminal title="warden.toml" showCopy={true}>
    <Code
      code={`version = 1

[[triggers]]
name = "Security Review"
event = "pull_request"
actions = ["opened", "synchronize"]
skill = "security-review"`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h2>GitHub App (Recommended)</h2>

  <p>
    Use a GitHub App instead of <code>GITHUB_TOKEN</code> for branded comments and cross-repo sharing.
  </p>

  <h3>Benefits</h3>

  <ul>
    <li>Comments appear from "Warden" instead of "github-actions"</li>
    <li>Share a single app across your organization</li>
    <li>Fine-grained permissions</li>
  </ul>

  <h3>1. Create the App</h3>

  <Terminal title="Terminal" showCopy={true}>
    <Code
      code={`# For an organization (recommended)
npx warden setup-app --org your-org

# For a personal account
npx warden setup-app`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>

  <p>The app gets these permissions:</p>

  <ul>
    <li><strong>Contents:</strong> Read</li>
    <li><strong>Pull requests:</strong> Write</li>
    <li><strong>Issues:</strong> Write</li>
    <li><strong>Checks:</strong> Write</li>
    <li><strong>Metadata:</strong> Read</li>
  </ul>

  <h3>2. Install the App</h3>

  <p>
    After creation, the command outputs an installation URL. Install the app on your repositories.
  </p>

  <h3>3. Add Organization Secrets</h3>

  <p>Add these to your organization secrets alongside the API key:</p>

  <table>
    <thead>
      <tr>
        <th>Secret</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>WARDEN_APP_ID</code></td>
        <td>App ID from the setup command</td>
      </tr>
      <tr>
        <td><code>WARDEN_PRIVATE_KEY</code></td>
        <td>Private key (full PEM contents)</td>
      </tr>
    </tbody>
  </table>

  <h3>4. Update Your Workflow</h3>

  <Terminal title=".github/workflows/warden.yml" showCopy={true}>
    <Code
      code={`name: Warden

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  WARDEN_ANTHROPIC_API_KEY: \${{ secrets.WARDEN_ANTHROPIC_API_KEY }}
  WARDEN_MODEL: \${{ secrets.WARDEN_MODEL }}

jobs:
  warden:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: \${{ secrets.WARDEN_APP_ID }}
          private-key: \${{ secrets.WARDEN_PRIVATE_KEY }}

      - uses: getsentry/warden-action@v1
        with:
          github-token: \${{ steps.app-token.outputs.token }}`}
      lang="yaml"
      theme="vitesse-black"
    />
  </Terminal>

  <h2>Configuration Reference</h2>

  <h3>Triggers</h3>

  <p>Each trigger maps a GitHub event to a skill.</p>

  <Terminal title="warden.toml" showCopy={true}>
    <Code
      code={`[[triggers]]
name = "Security Review"           # Display name
event = "pull_request"             # GitHub event
actions = ["opened", "synchronize"] # Event actions
skill = "security-review"          # Skill to run

# Filter by file paths
[triggers.filters]
paths = ["src/**/*.ts"]            # Only matching files
ignorePaths = ["**/*.test.ts"]     # Exclude patterns

# Output settings
[triggers.output]
failOn = "high"                    # Fail CI on high+ severity
commentOn = "high"                 # Comment on high+ severity
maxFindings = 10                   # Limit findings shown
labels = ["security"]              # Add labels when triggered`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h4>Supported Events</h4>

  <table>
    <thead>
      <tr>
        <th>Event</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>pull_request</code></td>
        <td><code>opened</code>, <code>synchronize</code>, <code>reopened</code>, <code>closed</code></td>
      </tr>
    </tbody>
  </table>

  <h3>Multiple Triggers</h3>

  <Terminal title="warden.toml" showCopy={true}>
    <Code
      code={`version = 1

# Security review on all PRs
[[triggers]]
name = "Security Review"
event = "pull_request"
actions = ["opened", "synchronize"]
skill = "security-review"

# API review on specific paths
[[triggers]]
name = "API Review"
event = "pull_request"
actions = ["opened"]
skill = "api-review"

[triggers.filters]
paths = ["src/api/**/*.ts"]`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h2>Verify Setup</h2>

  <p>Open a pull request. You should see:</p>

  <ol>
    <li>Warden running in PR checks</li>
    <li>Review comments on findings</li>
    <li>A summary comment</li>
  </ol>

  <h2>Local Development</h2>

  <p>Run Warden locally before pushing to catch issues early.</p>

  <Terminal title="Terminal" showCopy={true}>
    <Code
      code={`# Check uncommitted changes
warden --skill security-review

# Check commits since main
warden main..HEAD --skill security-review

# Auto-fix findings
warden --fix`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>
</Base>

<style>
  h1 {
    margin-bottom: 0.5rem;
  }

  h2 {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  h4 {
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.9rem;
  }

  th, td {
    text-align: left;
    padding: 0.75rem;
    border: 1px solid var(--border);
  }

  th {
    background: rgba(255, 255, 255, 0.03);
    font-weight: 600;
  }

  td code {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.85em;
  }

  ol, ul {
    padding-left: 1.5rem;
  }

  li {
    margin-bottom: 0.5rem;
  }
</style>
